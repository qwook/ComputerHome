{"version":3,"sources":["../../lib/gamescene.js"],"names":[],"mappings":"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","file":"gamescene.js","sourcesContent":["\"use strict\"\n\nvar gameMeta = require('./gamemeta.js');\nvar Player = require('./player.js');\n\nvar TICKRATE = 15;\nvar SNAPSHOTS = 100;\nvar SNAPSHOT_SEND_MOD = 10;\n\nif (CLIENT) {\n  SNAPSHOTS = 50;\n}\n\nclass GameScene extends THREE.Scene {\n  constructor() {\n    super();\n\n    global.game = this;\n\n    this.entityIdCount = 0;\n    this.entityMap = {}; // entityId -> entityObject\n\n    this.startTime = 0;\n    this.currentTick = 0;\n    this.offsetTick = 0;\n\n    this.snapshots = [];\n    this.snapshotMap = {}; // optimization\n\n    this.autoUpdate = false\n\n    /* Start ticking on the server! */\n    if (SERVER) {\n\n      // todo: replace this with a more accurate interval function\n      this.startTime = (new Date()).getTime();\n      this.currentTick = 0;\n      this.lastTick = this.currentTick;\n      var interval = () => {\n\n        this.currentTick = this.calculateTick();\n        var _oldTick = this.currentTick;\n\n        if (this.currentTick != this.lastTick) {\n\n          // console.log(this.currentTick);\n          // console.log((new Date()).getTime());\n\n          var _currentTick = this.currentTick;\n\n          this.replaySnapshots();\n\n          var c = 0;\n          for (var i = this.lastTick+1; i <= _currentTick; i++) {\n            c++;\n            if (c > 10) break;\n\n            this.currentTick = i;\n\n            this.update(TICKRATE / 1000);\n            this.pushSnapshot();\n\n            if (i % SNAPSHOT_SEND_MOD == 0) {\n              // setTimeout(() => {\n                var last = this.snapshots.length - 20;\n                if (last < 0) {last = 0;}\n                var oldSnapshot = this.snapshots[last];\n                primus.write({\n                  type: 'tick',\n                  tick: oldSnapshot.timestamp,\n                  snapshot: oldSnapshot\n                });\n              // }, 15);\n            }\n          }\n\n        }\n\n        this.lastTick = _oldTick;\n\n        setImmediate(interval);\n      }\n      interval();\n\n      // Someone has connected! Give them a player entity.\n      network.addEventListener('connection', (event) => {\n        var playerId = this.getNewId();\n        var player = new Player();\n        this.addEntId(player, playerId)\n\n        event.spark.entId = playerId;\n        event.spark.write({type: 'possess', entId: playerId});\n        event.spark.write({type: 'initialTick', startTime: this.startTime, realTimeStamp: (new Date()).getTime()});\n\n        delete this.snapshots;\n        delete this.snapshotMap;\n\n        this.snapshots = [];\n        this.snapshotMap = {};\n      });\n\n      network.addEventListener('disconnection', (event) => {\n        var entity = this.findEntityById(event.spark.entId);\n        if (entity) {\n          this.remove(entity);\n        }\n      });\n\n      // network.addEventListener('syncTick1', (event) => {\n      //   event.spark.write({type: 'syncTick1', realTimeStamp: (new Date()).getTime(), tick: this.currentTick});\n      // });\n\n      network.addEventListener('usersnapshot', (event) => {\n\n        // var snapshotMap = {};\n\n        for (var i in event.snapshots) {\n          var snapshot = event.snapshots[i];\n          // snapshotMap[snapshot.timestamp] = snapshot.move;\n\n          if (this.snapshotMap[snapshot.timestamp] &&\n              event.spark.entId &&\n              this.snapshotMap[snapshot.timestamp].entities[event.spark.entId] &&\n              this.snapshotMap[snapshot.timestamp].entities[event.spark.entId].vars\n          ) {\n            this.snapshotMap[snapshot.timestamp].entities[event.spark.entId].vars.move = snapshot.move;\n          } else {\n            // console.log(\"invalid input\" + snapshot.timestamp + \" \" + this.currentTick);\n          }\n        }\n\n\n        // var entity = this.findEntityById(event.spark.entId);\n        // if (entity) {\n        //   entity.snapshotMap = snapshotMap;\n        // }\n\n      \n      });\n\n    }\n\n    if (CLIENT) {\n\n      this.lastSnapshotTimestamp = 0;\n\n      // Possess a local player!\n      network.addEventListener('possess', (event) => {\n        var entity = this.findEntityById(event.entId);\n        if (!entity) {\n          entity = new Player();\n          this.addEntId(entity, event.entId)\n        }\n\n        entity.entId = event.entId;\n        global.localPlayer = entity;\n      })\n\n\n      network.addEventListener('initialTick', (event) => {\n\n        this.startTime = event.startTime;\n        this.currentTick = this.calculateTick();\n        this.lastTick = this.currentTick;\n        var interval = () => {\n\n          this.currentTick = this.calculateTick();\n          var _oldTick = this.currentTick;\n\n          if (this.currentTick != this.lastTick) {\n\n            var _currentTick = this.currentTick;\n\n            var c = 0;\n            for (var i = this.lastTick+1; i <= _currentTick; i++) {\n              c++;\n              if (c > 10) break;\n\n              this.currentTick = i\n\n              // copy system input and put it in actual\n              // calculated input\n              if (global.localPlayer) {\n                for (var key in localPlayer.localMoveTmp) {\n                  localPlayer.localMove[key] = localPlayer.localMoveTmp[key];\n                }\n              }\n\n              this.traverse((entity) => {\n                if (entity.className === 'Player' && entity != global.localPlayer) {\n                  // console.log(entity.snapshotMap);\n                  // for (var i = 0; i < 1; i++) {\n                    // if (entity.snapshotMap && entity.snapshotMap[this.currentTick]) {\n                      // entity.localMove = entity.snapshotMap[this.currentTick-20];\n                      var progress = (this.currentTick - this.lastSnapshotReceiveTime) / (this.snapshotLength || SNAPSHOT_SEND_MOD);\n                      if (progress < 0) {progress = 0;}\n                      if (progress > 1) {progress = 1;}\n                      // progress = 0.5;\n\n                      var netRotation = new THREE.Quaternion();\n                      netRotation.setFromEuler(entity.netRotation);\n                      entity.position.copy(entity.oldPosition);\n                      entity.quaternion.copy(entity.oldRotation);\n                      entity.position.lerp(entity.netPosition, progress);\n                      entity.quaternion.slerp(netRotation, progress);\n                      entity.localMove = {};\n\n                      entity.updateMatrixWorld(true);\n                      // console.log(entity.localMove);\n                      // break;\n                    // }\n                  // }\n                }\n              });\n\n              this.update(TICKRATE / 1000);\n\n              this.pushSnapshot();\n\n              if (global.localPlayer) {\n                // console.log(localPlayer.localMove);\n                // primus.write({type: 'usermove', tick: this.currentTick, move: localPlayer.localMove});\n              }\n\n            }\n\n              // if (i % 2 == 0) {\n            primus.write({type: 'usersnapshot', snapshots: this.snapshots.slice(this.snapshots.length-20)});\n              // }\n\n          }\n\n          // this.replayUser(this.lastSnapshot);\n\n          this.lastTick = _oldTick;\n\n          requestAnimationFrame(interval);\n        };\n        interval();\n      });\n\n      // we received a snapshot\n      network.addEventListener('tick', (event) => {\n        if (event.snapshot.timestamp > this.lastSnapshotTimestamp) {\n          this.replayUser(event.snapshot);\n          if (this.lastSnapshot) {\n            this.snapshotLength = event.snapshot.timestamp - this.lastSnapshot.timestamp;\n          }\n          this.lastSnapshot = event.snapshot;\n          this.lastSnapshotTimestamp = event.snapshot.timestamp;\n        }\n      });\n\n    }\n\n    // Create static elements!\n    var geometry = new THREE.BoxGeometry( 20, 20, 0.1 );\n    var material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );\n    if (CLIENT) {\n      var texture = new THREE.TextureLoader().load( \"grass.png\" );\n      texture.minFilter = THREE.NearestFilter;\n      texture.magFilter = THREE.NearestFilter;\n      material.map = texture;\n    }\n    var cube = new THREE.Mesh( geometry, material );\n    cube.position.z = 0;\n    this.add( cube );\n  }\n\n  pushSnapshot() {\n    var snapshot;\n\n    if (SERVER) {\n      snapshot = this.serialize(true);\n    } else if (global.localPlayer) {\n      snapshot = {timestamp: this.currentTick, move: JSON.parse(JSON.stringify(localPlayer.localMove))};\n    }\n\n    this.snapshots.push(snapshot);\n    this.snapshotMap[snapshot.timestamp] = snapshot;\n\n    // automatically pop old snapshots\n    if (this.snapshots.length > SNAPSHOTS) {\n      var oldSnapshot = this.snapshots.shift();\n      delete this.snapshotMap[oldSnapshot.timestamp];\n    }\n  }\n\n  getNewId() {\n    return ++this.entityIdCount;\n  }\n\n  findEntityById(id) {\n    return this.entityMap[id];\n  }\n\n  serialize() {\n    var serial = {\n      timestamp: this.currentTick,\n      entities: {}\n    };\n\n    this.traverse((entity) => {\n      if (entity.entId && entity.dynamic) {\n        var pos = {x: entity.position.x, y: entity.position.y, z: entity.position.z}\n        var rot = {x: entity.rotation.x, y: entity.rotation.y, z: entity.rotation.z}\n        serial.entities[entity.entId] = {\n          className: entity.className,\n          vars: JSON.parse(JSON.stringify(entity.syncedVars)), // deep copy\n          pos: pos,\n          rot: rot\n        };\n      }\n    })\n\n    return serial;\n  }\n\n  applySnapshot(snapshot, ignorePosition) {\n    var oldSnapshot = this.serialize();\n\n    // updated\n    for (var i in snapshot.entities) {\n      var serial = snapshot.entities[i];\n      var entity = this.entityMap[i];\n      // add entity\n      if (!entity) {\n        entity = gameMeta.createClass(serial.className);\n        this.addEntId(entity, i);\n      }\n\n      // if (CLIENT) {\n      //   entity.snapshotMap = serial.snapshotMap;\n      // }\n\n      if (!ignorePosition) {\n        if (CLIENT && entity != localPlayer) {\n          if (this.lastSnapshot && this.lastSnapshot.entities[i]) {\n            entity.oldPosition.copy(this.lastSnapshot.entities[i].pos);\n            var rot = new THREE.Euler();\n            rot.set(this.lastSnapshot.entities[i].rot.x, this.lastSnapshot.entities[i].rot.y, this.lastSnapshot.entities[i].rot.z);\n            entity.oldRotation.setFromEuler(rot);\n          }\n          entity.netPosition.set(serial.pos.x, serial.pos.y, serial.pos.z);\n          entity.netRotation.set(serial.rot.x, serial.rot.y, serial.rot.z);\n        } else {\n          entity.position.set(serial.pos.x, serial.pos.y, serial.pos.z);\n          entity.rotation.set(serial.rot.x, serial.rot.y, serial.rot.z);\n        }\n\n        delete entity.syncedVars;\n        entity.syncedVars = JSON.parse(JSON.stringify(serial.vars));\n      } else {\n        entity.syncedVars.move = serial.vars.move\n      }\n    }\n\n    // deleted\n    for (var i in oldSnapshot.entities) {\n      if (!snapshot.entities[i]) {\n        this.removeById(i);\n      }\n    }\n  }\n\n  // client prediction\n  // also simulate other player movements\n  replayUser(snapshot) {\n    if (!snapshot) return;\n\n    this.lastSnapshotReceiveTime = this.currentTick;\n\n    this.applySnapshot(snapshot);\n    this.updateMatrix();\n    this.updateMatrixWorld(true);\n\n    if (this.snapshots.length == 0) return;\n\n    if (!global.localPlayer) return;\n\n    var _currentTick = this.currentTick;\n    var _localMove = localPlayer.localMove;\n\n    for (var i = snapshot.timestamp+1; i <= _currentTick; i++) {\n\n      this.currentTick = i;\n\n      if (this.snapshotMap[i]) {\n        localPlayer.localMove = this.snapshotMap[i].move;\n      } else {\n        // console.log(\"lost packet \" + i + \" for \" + snapshot.timestamp + \" \" + _currentTick);\n      }\n\n      this.update(TICKRATE/1000);\n\n    }\n\n    localPlayer.localMove = _localMove;\n    this.currentTick = _currentTick;\n  }\n\n  // server\n  replaySnapshots() {\n    if (this.snapshots.length == 0) return;\n\n    this.applySnapshot(this.snapshots[0]);\n\n    var _currentTick = this.currentTick;\n\n    // replay all user input\n    for (var i = 1; i < this.snapshots.length; i++) {\n      this.currentTick = this.snapshots[i].timestamp;\n\n      this.applySnapshot(this.snapshots[i], true);\n      this.update(TICKRATE/1000);\n\n      delete this.snapshotMap[this.snapshots[i].timestamp];\n      delete this.snapshots[i];\n      var newSnapshot = this.serialize();\n      this.snapshots[i] = newSnapshot;\n      this.snapshotMap[this.snapshots[i].timestamp] = newSnapshot;\n    }\n\n    this.currentTick = _currentTick;\n\n  }\n\n  update(delta) {\n    this.traverse((entity) => {\n      if (entity.dynamic && entity.update) {\n        entity.update(delta);\n      }\n    })\n\n    if (CLIENT && global.localPlayer) {\n\n      var offset = new THREE.Vector3(0, -3, 3);\n      var pos = global.localPlayer.position.clone();\n      pos.add(offset);\n      global.camera.position.copy(pos);\n\n    }\n\n    this.updateMatrix();\n    this.updateMatrixWorld( true );\n  }\n\n  addEntId(obj, entId) {\n    obj.entId = entId;\n    this.entityMap[entId] = obj;\n    this.add(obj);\n  }\n\n  removeById(id) {\n    var obj = this.findEntityById(id);\n    this.entityMap[obj.entId] = null;\n\n    if (obj) {\n      this.remove(obj);\n    }\n  }\n\n  calculateTick() {\n    if (SERVER) {\n      return Math.floor(((new Date()).getTime() - this.startTime) / TICKRATE) + this.offsetTick;\n    } else {\n      return Math.floor((ts.now() - this.startTime) / TICKRATE) + this.offsetTick - 10;\n    }\n  }\n}\n\nmodule.exports = GameScene;\n"]}