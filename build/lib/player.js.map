{"version":3,"sources":["../../lib/player.js"],"names":[],"mappings":"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","file":"player.js","sourcesContent":["\"use strict\"\n\nvar gameMeta = require('./gamemeta.js');\n\n// Player control\nif (CLIENT) {\n\n  document.addEventListener('keydown', function(event) {\n    if (!global.localPlayer) {\n      return;\n    }\n\n    if (event.which == 38) {\n      localPlayer.localMove.forward = true;\n    } else if (event.which == 40) {\n      localPlayer.localMove.backward = true;\n    } else if (event.which == 37) {\n      localPlayer.localMove.left = true;\n    } else if (event.which == 39) {\n      localPlayer.localMove.right = true;\n    }\n  });\n\n  document.addEventListener('keyup', function(event) {\n    if (!localPlayer) {\n      return;\n    }\n\n    if (event.which == 38) {\n      localPlayer.localMove.forward = false;\n    } else if (event.which == 40) {\n      localPlayer.localMove.backward = false;\n    } else if (event.which == 37) {\n      localPlayer.localMove.left = false;\n    } else if (event.which == 39) {\n      localPlayer.localMove.right = false;\n    }\n  });\n \n}\n\nclass Player extends THREE.Object3D {\n  constructor() {\n    super();\n\n    this.entId = null;\n    this.dynamic = true;\n\n    if (CLIENT) {\n      this.localMove = {\n        forward: false,\n        backward: false,\n        left: false,\n        right: false\n      };\n\n      this.snapshots = {};\n    }\n\n    this.syncedVars = {\n      move: {\n        forward: false,\n        backward: false,\n        left: false,\n        right: false\n      }\n    };\n\n    var geometry = new THREE.BoxGeometry( 1, 1, 1 );\n    var material = new THREE.MeshBasicMaterial( { color: 0xffffff } );\n    var cube = new THREE.Mesh( geometry, material );\n    cube.position.z += 1;\n    this.add( cube );\n\n    if (CLIENT) {\n      this.name = document.createElement('div');\n      document.body.appendChild(this.name);\n      this.name.className = 'nametag';\n      this.name.style.position = 'absolute';\n      this.name.style.top = 10 + 'px';\n      this.name.style.left = 10 + 'px';\n    }\n  }\n\n  update(delta) {\n\n    var move = this.syncedVars.move;\n\n    if (CLIENT) {\n      var namePos3D = this.position.clone();\n      namePos3D.z += 2;\n      var namePos = calc3Dto2D(namePos3D);\n      // console.log(namePos);\n      this.name.style.left = Math.floor((namePos.x+1)/2*500) + 'px';\n      this.name.style.top = (500-Math.floor((namePos.y+1)/2*500)) + 'px';\n\n      if (this == localPlayer) {\n        move = this.localMove;\n        primus.write({type: 'usermove', tick: game.currentTick, move: this.localMove});\n        // console.log(\"move\");\n      }\n    }\n\n    var collide = false;\n    game.traverse((entity) => {\n      if (entity == this || collide || !entity.dynamic) {\n        return;\n      }\n\n      var distance = entity.position.distanceTo(this.position);\n\n      var push = new THREE.Vector3().subVectors(entity.position, this.position);\n      push.normalize();\n      push.multiplyScalar(2*delta);\n\n      // opposite push\n      var opush = push.clone();\n      opush.multiplyScalar(-1);\n\n      if (distance == 0) {\n        entity.position.add(new THREE.Vector3(1,1,0));\n      }\n\n      if (distance < 1) {\n        entity.position.add(push);\n        collide = true;\n      }\n    })\n\n    if (collide) {\n      return;\n    }\n\n    if (move.forward) {\n      this.position.x += Math.cos(this.rotation.z) * 2 * delta;\n      this.position.y += Math.sin(this.rotation.z) * 2 * delta;\n    }\n\n    if (move.backward) {\n      this.position.x -= Math.cos(this.rotation.z) * 2 * delta;\n      this.position.y -= Math.sin(this.rotation.z) * 2 * delta;\n    }\n\n    if (move.left) {\n      this.rotation.z += 3 * delta;\n    }\n\n    if (move.right) {\n      this.rotation.z -= 3 * delta;\n    }\n\n  }\n}\n\ngameMeta.registerClass(\"Player\", Player)\nmodule.exports = Player;\n"]}