{"version":3,"sources":["../../lib/player.js"],"names":[],"mappings":"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","file":"player.js","sourcesContent":["\"use strict\"\n\nvar gameMeta = require('./gamemeta.js');\n\n// Player control\nif (CLIENT) {\n\n  function keyByAngle(x, y) {\n    var ang = Math.atan2(y-250-10, x-250-10);\n    // console.log(ang);\n\n    if (ang < -Math.PI/3 && ang > -Math.PI*2/3) {\n      return 'forward';\n      return;\n    }\n\n    if (ang > Math.PI/3 && ang < Math.PI*2/3) {\n      return 'backward';\n      return;\n    }\n\n    if (ang > -Math.PI*2/3 && ang < Math.PI*2/3) {\n      return 'right';\n      return;\n    }\n\n    if (ang < -Math.PI*2/4 || ang > Math.PI*2/4) {\n      return 'left';\n      return;\n    }\n  }\n\n  function clear() {\n    for (var k in localPlayer.localMove) {\n      localPlayer.localMove[k] = false;\n    }\n  }\n\n  canvas.addEventListener('touchstart', function(event) {\n    var key = keyByAngle(event.changedTouches[0].pageX, event.changedTouches[0].pageY);\n    clear();\n    localPlayer.localMove[key] = true;\n    event.preventDefault();\n  });\n\n  canvas.addEventListener('touchmove', function(event) {\n    var key = keyByAngle(event.changedTouches[0].pageX, event.changedTouches[0].pageY);\n    clear();\n    localPlayer.localMove[key] = true;\n    event.preventDefault();\n  });\n\n  canvas.addEventListener('touchend', function(event) {\n    clear();\n    event.preventDefault();\n  });\n\n  var mdown = false;\n  canvas.addEventListener('mousedown', function(event) {\n    var key = keyByAngle(event.pageX, event.pageY);\n    clear();\n    localPlayer.localMove[key] = true;\n    mdown = true;\n    event.preventDefault();\n  });\n\n  canvas.addEventListener('mousemove', function(event) {\n    if (mdown) {\n      var key = keyByAngle(event.pageX, event.pageY);\n      clear();\n      localPlayer.localMove[key] = true;\n    }\n    event.preventDefault();\n  });\n\n  canvas.addEventListener('mouseup', function(event) {\n    console.log('up');\n    mdown = false;\n    clear();\n    event.preventDefault();\n  });\n\n  document.addEventListener('keydown', function(event) {\n    if (!global.localPlayer) {\n      return;\n    }\n\n    if (event.which == 38) {\n      localPlayer.localMove.forward = true;\n      event.preventDefault();\n    } else if (event.which == 40) {\n      localPlayer.localMove.backward = true;\n      event.preventDefault();\n    } else if (event.which == 37) {\n      localPlayer.localMove.left = true;\n      event.preventDefault();\n    } else if (event.which == 39) {\n      localPlayer.localMove.right = true;\n      event.preventDefault();\n    }\n\n  });\n\n  document.addEventListener('keyup', function(event) {\n    if (!global.localPlayer) {\n      return;\n    }\n\n    if (event.which == 38) {\n      localPlayer.localMove.forward = false;\n    } else if (event.which == 40) {\n      localPlayer.localMove.backward = false;\n    } else if (event.which == 37) {\n      localPlayer.localMove.left = false;\n    } else if (event.which == 39) {\n      localPlayer.localMove.right = false;\n    }\n\n    event.preventDefault();\n  });\n \n}\n\nclass Player extends THREE.Object3D {\n  constructor() {\n    super();\n\n    this.entId = null;\n    this.dynamic = true;\n\n    if (CLIENT) {\n      this.localMove = {\n        forward: false,\n        backward: false,\n        left: false,\n        right: false\n      };\n\n      this.snapshots = {};\n    }\n\n    this.syncedVars = {\n      move: {\n        forward: false,\n        backward: false,\n        left: false,\n        right: false\n      }\n    };\n\n    var geometry = new THREE.BoxGeometry( 1, 1, 1 );\n    var material = new THREE.MeshBasicMaterial( { color: 0xff0000 } );\n    var cube = new THREE.Mesh( geometry, material );\n    cube.position.z += 1;\n    this.add( cube );\n\n    if (CLIENT) {\n      var texture = new THREE.TextureLoader().load( \"danny.jpg\" );\n      texture.minFilter = THREE.NearestFilter;\n      texture.magFilter = THREE.NearestFilter;\n      var geometryFace = new THREE.BoxGeometry( 0.5, 0.1, 0.5 );\n      var materialFace = new THREE.MeshBasicMaterial( { color: 0xffffff, map: texture } );\n      var cubeFace = new THREE.Mesh( geometryFace, materialFace );\n      cubeFace.position.y -= 0.5;\n      cubeFace.position.z += 1;\n      this.add( cubeFace );\n    }\n\n    if (CLIENT) {\n      this.name = document.createElement('div');\n      document.body.appendChild(this.name);\n      this.name.className = 'nametag';\n      this.name.style.position = 'absolute';\n      this.name.style.top = 10 + 'px';\n      this.name.style.left = 10 + 'px';\n    }\n\n    this.addEventListener('removed', () => {\n      this.destroy();\n    })\n  }\n\n  destroy() {\n    if (CLIENT) {\n      this.name.parentNode.removeChild(this.name);\n    }\n  }\n\n  update(delta) {\n\n    var move = this.syncedVars.move;\n\n    if (CLIENT) {\n      var namePos3D = this.position.clone();\n      namePos3D.z += 2;\n      var namePos = calc3Dto2D(namePos3D);\n      // console.log(namePos);\n      this.name.style.left = Math.floor((namePos.x+1)/2*500) + 'px';\n      this.name.style.top = (500-Math.floor((namePos.y+1)/2*500)) + 'px';\n\n      if (this == localPlayer) {\n        move = this.localMove;\n      }\n    }\n\n    var collide = false;\n    game.traverse((entity) => {\n      if (entity == this || collide || !entity.dynamic) {\n        return;\n      }\n\n      var distance = entity.position.distanceTo(this.position);\n\n      var push = new THREE.Vector3().subVectors(entity.position, this.position);\n      push.normalize();\n      push.multiplyScalar(2*delta);\n\n      // opposite push\n      var opush = push.clone();\n      opush.multiplyScalar(-1);\n\n      if (distance == 0) {\n        entity.position.add(new THREE.Vector3(1,1,0));\n      }\n\n      if (distance < 1) {\n        entity.position.add(push);\n        collide = true;\n      }\n    })\n\n    if (collide) {\n      return;\n    }\n\n    if (move.forward) {\n      this.position.x += Math.cos(this.rotation.z-Math.PI/2) * 5 * delta;\n      this.position.y += Math.sin(this.rotation.z-Math.PI/2) * 5 * delta;\n\n    }\n\n    if (move.backward) {\n      this.position.x -= Math.cos(this.rotation.z-Math.PI/2) * 5 * delta;\n      this.position.y -= Math.sin(this.rotation.z-Math.PI/2) * 5 * delta;\n    }\n\n    if (move.left) {\n      this.rotation.z += 4 * delta;\n    }\n\n    if (move.right) {\n      this.rotation.z -= 4 * delta;\n    }\n\n  }\n}\n\ngameMeta.registerClass(\"Player\", Player)\nmodule.exports = Player;\n"]}